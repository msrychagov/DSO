# BDD Сценарии для Security NFR

## Обзор
Данный документ содержит BDD сценарии в формате Gherkin для проверки выполнения Security NFR.

## NFR-01: Хранение паролей

### Позитивный сценарий
```gherkin
Feature: Безопасное хранение паролей
  Scenario: Пароли хэшируются с использованием Argon2id
    Given пользователь регистрируется с паролем "SecurePass123!"
    When система сохраняет пароль в базе данных
    Then пароль должен быть захеширован с параметрами Argon2id t=3, m=256MB, p=1
    And исходный пароль не должен храниться в открытом виде
```

### Негативный сценарий
```gherkin
Feature: Безопасное хранение паролей
  Scenario: Защита от слабых параметров хэширования
    Given система настроена с небезопасными параметрами Argon2id
    When пользователь пытается зарегистрироваться
    Then система должна отклонить регистрацию
    And должна быть выдана ошибка "Небезопасные параметры хэширования"
```

## NFR-02: Ошибки в формате RFC7807

### Позитивный сценарий
```gherkin
Feature: Стандартизированные ошибки API
  Scenario: API возвращает ошибки в формате RFC7807
    Given API endpoint /items/999 не существует
    When клиент делает запрос GET /items/999
    Then ответ должен содержать заголовок Content-Type: application/problem+json
    And тело ответа должно содержать поля: type, title, status, detail, instance
    And поле instance должно содержать correlation_id
```

### Негативный сценарий
```gherkin
Feature: Стандартизированные ошибки API
  Scenario: Защита от утечки PII в ошибках
    Given пользователь с email "user@example.com" пытается получить несуществующий ресурс
    When API возвращает ошибку 404
    Then в теле ответа не должно быть email пользователя
    And PII данные должны быть замаскированы
```

## NFR-03: Производительность логина

### Позитивный сценарий
```gherkin
Feature: Производительность аутентификации
  Scenario: p95 логина держится под порогом на stage
    Given сервис развернут на stage окружении
    And настроена нагрузка 50 RPS
    When запускается 5-минутный нагрузочный тест на endpoint /login
    Then p95 времени ответа должен быть ≤ 300 ms
    And количество успешных запросов должно быть ≥ 95%
```

### Негативный сценарий
```gherkin
Feature: Производительность аутентификации
  Scenario: Система выдерживает пиковую нагрузку
    Given сервис работает под нормальной нагрузкой
    When происходит резкий скачок нагрузки до 200 RPS
    Then система должна продолжить обрабатывать запросы
    And время ответа не должно превышать 1 секунду
    And система должна автоматически масштабироваться
```

## NFR-04: Уязвимости зависимостей

### Позитивный сценарий
```gherkin
Feature: Управление уязвимостями зависимостей
  Scenario: Обнаружение и устранение критических уязвимостей
    Given в зависимостях обнаружена уязвимость с уровнем High
    When система запускает SCA сканирование
    Then уязвимость должна быть зафиксирована в системе отслеживания
    And должен быть создан тикет на устранение в течение 7 дней
    And CI/CD пайплайн должен блокировать деплой до устранения
```

### Негативный сценарий
```gherkin
Feature: Управление уязвимостями зависимостей
  Scenario: Блокировка деплоя при критических уязвимостях
    Given в зависимостях есть неисправленная уязвимость Critical
    When разработчик пытается задеплоить изменения
    Then CI/CD пайплайн должен заблокировать деплой
    And должна быть выдана ошибка с указанием уязвимости
    And деплой должен быть разрешен только после устранения
```

## NFR-07: Rate Limiting

### Позитивный сценарий
```gherkin
Feature: Защита от brute force атак
  Scenario: Rate limiting работает корректно
    Given API Gateway настроен с лимитом 5 запросов в минуту
    When IP адрес делает 3 запроса к /login за минуту
    Then запросы должны обрабатываться успешно
    And в логах должны быть зафиксированы все запросы
```

### Негативный сценарий
```gherkin
Feature: Защита от brute force атак
  Scenario: Блокировка при превышении лимита
    Given API Gateway настроен с лимитом 5 запросов в минуту
    When IP адрес делает 6 запросов к /login за минуту
    Then 6-й запрос должен быть заблокирован с кодом 429
    And должен быть возвращен заголовок Retry-After
    And IP должен быть временно заблокирован на 5 минут
```

## NFR-08: HTTPS/TLS

### Позитивный сценарий
```gherkin
Feature: Шифрование соединений
  Scenario: Все соединения используют TLS 1.3+
    Given сервис настроен с поддержкой TLS 1.3
    When клиент подключается к API через HTTPS
    Then соединение должно использовать TLS 1.3 или выше
    And SSL Labs тест должен показать оценку A+
    And должны быть отключены устаревшие протоколы
```

### Негативный сценарий
```gherkin
Feature: Шифрование соединений
  Scenario: Блокировка небезопасных соединений
    Given сервис настроен только с TLS 1.3+
    When клиент пытается подключиться с TLS 1.2
    Then соединение должно быть отклонено
    And должна быть выдана ошибка "Unsupported TLS version"
    And в логах должно быть зафиксировано событие безопасности
```

## NFR-10: Мониторинг аномалий

### Позитивный сценарий
```gherkin
Feature: Детекция аномальной активности
  Scenario: Система обнаруживает подозрительную активность
    Given система мониторинга настроена на детекцию аномалий
    When происходит 100 неудачных попыток входа с одного IP за 5 минут
    Then система должна сгенерировать алерт в течение 5 минут
    And алерт должен содержать детали аномалии
    And IP должен быть автоматически заблокирован
```

### Негативный сценарий
```gherkin
Feature: Детекция аномальной активности
  Scenario: Ложные срабатывания минимизированы
    Given система мониторинга настроена с высоким порогом чувствительности
    When происходит нормальная активность пользователей
    Then система не должна генерировать ложные алерты
    And количество false positive должно быть ≤ 5% от общего числа алертов
```
