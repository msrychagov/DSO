# ADR-004 — Secure Coding Controls for P06

- **Статус:** Accepted
- **Дата:** 2025-11-16
- **Контексты:** NFR-02, NFR-06, NFR-10; Threat Model R2/R6/R8

## Контекст

Практика P06 требует внедрить измеримые контроли безопасного кодирования в рабочем сервисе и подтвердить их тестами. После P03 (NFR) и P04 (Threat Model) были открыты риски:

- **R2/R8** — неконтролируемые входные данные/денормализованные даты приводят к ошибкам сериализации и логическим обходам;
- **R6** — отсутствие единообразных ответов и трассировки ошибок мешает расследованиям;
- **R5** — загрузки файлов без нормализации пути/типа позволяют перенаправить запись вне каталога.

Нужно усилить доменный слой (`src/services`) и публичное API (`src/app/api.py`), а также зафиксировать это в CI.

## Решение

1. **Строгая валидация платежей (`src/services/payment_service.py`).**
   - JSON парсится через `json.loads(..., parse_float=str)` → исключаем неявные float’ы.
   - `PaymentPayload` (Pydantic v2) ограничивает Decimal (`max_digits=12, decimal_places=2`), валюту `^[A-Z]{3}$`, даты приводятся к UTC.
   - При ошибках выбрасывается `PaymentValidationError` с сериализуемой картой ошибок (маска для Decimal).
   - Покрыто тестами `tests/test_payments.py` (позитив + 3 негативных сценария).
   - Обеспечивает **NFR-02** (валидный контракт), снижает **R2/R8**.

2. **Единый механизм RFC 7807 и аудит (`src/app/api.py`).**
   - `_problem_response` гарантирует наличие `correlation_id` (совместимо с **NFR-10**) и кодов ошибок.
   - Middleware сначала ставит корреляцию, потом накладывает security headers; rate limiting ошибки автоматически оборачиваются.
   - Все REST endpoints (auth/items/payments/uploads) теперь используют только проблем-ответы — закрытие **NFR-02**, **R6**.

3. **Безопасные загрузки файлов (`src/app/api.py` + `src/security/uploads.py`).**
   - Встроенный endpoint `/api/v1/uploads` вызывает `secure_store`, который проверяет magic bytes PNG/JPEG, лимит 5 МБ, UUID-имена, запрет path traversal.
   - Негативные тесты в `tests/test_src_uploads.py` проверяют слишком большой файл и поддельную сигнатуру.
   - Адресует риски **R5/R6** и связывает уже существующий модуль с основным API.

4. **CI-пайплайн (.github/workflows/ci.yml).**
   - GitHub Actions запускают `ruff`, `black`, `isort`, `pytest`, `pre-commit` на Python 3.11 и 3.12 при каждом push/PR.
   - Даёт доказательство по **C4**: стиль и тесты блокируют мерж.

## Последствия

- Валидация и ошибки стали строгими; клиенты получают детализированные, но безопасные ответы.
- Аудит и storage-контроли теперь проверяются автоматическими тестами и не зависят от ручной настройки `app/main.py`.
- Расширенный CI покрывает новый функционал локально и в PR.

## Тесты / Доказательства

- `pytest` (69 тестов, включая `tests/test_payments.py` и `tests/test_src_uploads.py`) — локальный протокол приложен в отчёт `docs/reports/p06-secure-coding.md`.
- GitHub Actions workflow `CI` запускает тот же набор команд.
