# ADR-002: Secure Handling of User File Uploads
Дата: 2025-10-20
Статус: Accepted

## Context
- MVP сервиса не содержит защиты при приёме файлов, что открывает возможность загрузки произвольного контента, переполнения хранилища и path traversal.
- Threat model (`F4 API Service` и `F6 Database`) подчёркивает угрозы Tampering/DoS при работе с данными.
- В risk register риск `R4` (DDoS) фиксирует необходимость ограничения ресурсоёмких запросов, к которым относятся и крупные загрузки.
- Клиентская команда запросила возможность безопасно прикреплять изображения к сущностям, но с гарантией фильтрации контента.

## Decision
- Реализуем модуль `src.security.uploads.secure_store`:
  - жёсткий лимит 5 МБ и контроль тайм-аута чтения (через `UploadFile` на стороне FastAPI);
  - проверка magic bytes (`PNG`, `JPEG`), MIME whitelist и нормализация путей;
  - генерация имён файлов как UUID + расширение, запрет симлинков и traversal.
- Добавляем endpoint `POST /uploads` (FastAPI) с конфигурацией базовой директории из `UPLOAD_STORAGE_PATH`, по умолчанию `./var/uploads`.
- Возвращаем только служебную метаинформацию (`resource_id`, `media_type`), исходное имя клиента не сохраняется.
- При нарушении правил выдаём RFC 7807 ошибки (`413` для превышения размера, `415` для неизвестного типа, `400` для traversal).

## Alternatives
1. **Хранить файлы в S3/GCS без локальной валидации** — переносит ответственность на storage, но не останавливает DoS по входящему трафику.
2. **Использовать антивирус/IDS до сохранения** — повышает безопасность, но чрезмерно для MVP и усложняет CI.
3. **Отказаться от загрузок** — не покрывает пользовательские сценарии продукта.

## Consequences
- Локальное хранилище управляется сервисом, появляется необходимость мониторить свободное место и ротацию.
- Требуются дополнительные тесты (позитивные и негативные кейсы) и мок окружения при CI.
- Код upload модуля становится общей точкой для повторного использования в других сервисах.

## Security impact
- **+** Ограничение типов и размеров снижает риск `R4` (DoS) и Tampering через обработку бинарных данных.
- **+** Канонизация путей и отказ от пользовательских имён пресекают path traversal.
- **–** Придётся учитывать стоимость обработки в памяти (чтение файла целиком), в backlog оставлен пункт на потоковую валидацию.

## Rollout plan
1. Создать директорию `var/uploads` в окружениях, задать переменные `UPLOAD_STORAGE_PATH`.
2. Выпустить сервис с новым endpoint, провести нагрузочные тесты на 4-5 МБ файлах.
3. Настроить мониторинг ошибок 4xx/5xx и объёма хранилища.
4. Рассмотреть интеграцию с бесплатным malware scanner'ом на следующем этапе.

## Links
- NFR-02
- F4, R4
- tests/test_file_uploads.py::test_rejects_oversized_payload
