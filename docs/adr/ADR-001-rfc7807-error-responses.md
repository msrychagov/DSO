# ADR-001: RFC 7807 Problem Details for API Errors
Дата: 2025-10-20
Статус: Accepted

## Context
- В `app.main` и `app.test_app` ошибки возвращались в кастомном формате `{"error": {...}}`, что не соответствует корпоративному стандарту NFR-02 (RFC 7807) и усложняет обработки ошибок на стороне клиентов.
- В risk register (`R2`) зафиксирован риск утечки PII через сообщения об ошибках. При текущей реализации детали исключений могут просочиться в ответ.
- Threat model (поток `F3 Auth Service`) требует единообразной сериализации ошибок, чтобы облегчит маскирование чувствительных данных.
- Нужен единый способ генерации `correlation_id` для трассировки запросов между сервисами и аудитом.

## Decision
- Вводим модуль `src.security.problem_details.problem_response`, который формирует RFC 7807 JSON (`type`, `title`, `status`, `detail`, `correlation_id`, `instance`) и опциональные `extras`.
- Все обработчики исключений FastAPI (`ApiError`, `HTTPException`, `Exception`) используют этот модуль. Для неизвестных ошибок detail маскируется.
- При превышении rate limit и других middleware-ошибках также возвращаем RFC 7807 с кодами `429`/`403` и корректным `Retry-After` (если применяется).
- `correlation_id` генерируется один раз на исключение, прокидывается в логи и ответы.

## Alternatives
1. **Сохранить кастомный формат** — дёшево, но нарушает NFR-02 и осложняет интеграции.
2. **Использовать стороннюю библиотеку (например, `fastapi-problems`)** — унифицирует подход, но добавляет внешнюю зависимость и не позволяет гибко маскировать детали.
3. **Форматировать ошибки силами API Gateway** — снижает работу на сервисе, но требует глобального рефакторинга и усложняет тестирование на уровне сервиса.

## Consequences
- Клиенты получают стандартизированную схему ошибок, контракт проще документировать.
- Появляется дополнительный слой абстракции (модуль problem details), который нужно сопровождать — оправдано контролем безопасности.
- Потребовалась миграция тестов и документации под новый формат.

## Security impact
- **+** Минимизируем риск `R2` утечки PII через ошибки: детализация исключений скрыта за безопасными сообщениями.
- **+** `correlation_id` помогает расследовать инциденты и соотнести логи в SIEM (поддержка NFR-06).
- **–** Дополнительное вычисление UUID не критично, но добавляет незначительный overhead (<1% времени ответа при профилировании на stage).

## Rollout plan
1. Добавить модуль и заменить обработчики ошибок в сервисе (`app.main`, `app.test_app`).
2. Обновить контрактные и модульные тесты на формат RFC 7807.
3. Включить проверку формата ошибок в CI (pytest).
4. На этапе канареечного развертывания собрать метрики по количеству 4xx/5xx для сравнения с бенчмарком.

## Links
- NFR-02
- F3, R2
- tests/test_problem_details.py::test_validation_error_returns_problem_details
