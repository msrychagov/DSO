# ADR-003: Enhanced Rate Limiting Responses and Observability
Дата: 2025-10-20
Статус: Accepted

## Context
- Базовая реализация `RateLimiter` ограничивает только частоту запросов, но не сообщает клиенту окно повторной попытки и не использует стандартизированный формат ошибок.
- По NFR-07 требуется ≤5 попыток/мин на IP и мониторинг срабатываний; risk register (`R1`) фиксирует угрозу брутфорса `/login`.
- Threat model (`F1 /login`) рекомендует rate limiting + расширенное логирование.
- Отсутствие `Retry-After` мешает клиентам корректно backoff'ить, а отсутствие метрик усложняет мониторинг.

## Decision
- Расширяем `RateLimiter`:
  - храним timestamp первого запроса в окне и рассчитываем `retry_after_seconds`;
  - возвращаем RFC 7807 ошибку `429` с `title="Rate limit exceeded"` и `Retry-After` заголовком;
  - логируем событие в `AuditLogger` с `correlation_id` для SIEM.
- Экспортируем конфигурацию через `RATE_LIMIT_MAX_REQUESTS`/`RATE_LIMIT_WINDOW_SECONDS` (env), по умолчанию 5 запросов/60 секунд.
- Добавляем unit/contract тесты на превышение лимита и граничный случай ровно 5 запросов.

## Alternatives
1. **Переложить rate limiting на API Gateway** — уменьшает нагрузку на сервис, но не покрывает локальные сценарии (CLI, internal API) и не даёт unit-тестов.
2. **Использовать Redis/Token bucket** — готово к продакшену, но требует дополнительной инфраструктуры, которая пока отсутствует на stage.
3. **Оставить текущую реализацию** — минимальные изменения, но без `Retry-After` и тестов NFR-07 не считается выполненным.

## Consequences
- Появляется привязка к переменным окружения (нужно добавить в Helm/compose).
- Запросы, вышедшие за лимит, получают детальное сообщение, что улучшает UX клиентов.
- Объём логов увеличится (каждый блокированный запрос).

## Security impact
- **+** Снижается вероятность успешного brute force (`R1`), так как клиенты обязаны ждать повторного окна.
- **+** `Retry-After` + `correlation_id` облегчает интеграцию с мониторингом (dashboards на количество 429).
- **–** При большом потоке IP'ов хранение их state in-memory может расти; для продакшена запланирован переход на Redis-backed лимитер.

## Rollout plan
1. Обновить конфигурацию сервисов (env vars) и задеплоить обновлённый middleware.
2. Добавить pytest, который фиксирует контракт на `Retry-After` и RFC 7807 структуру, включить его в CI.
3. В мониторинге завести алерт на >100 rate-limit срабатываний/минуту.
4. После пилота оценить необходимость выноса стейта в Redis.

## Links
- NFR-07
- F1, R1
- tests/test_rate_limiting.py::test_rate_limit_returns_retry_after
